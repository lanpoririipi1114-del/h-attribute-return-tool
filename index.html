<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hå±æ€§ è¿”é€æ–‡è¨€ä½œæˆãƒ„ãƒ¼ãƒ«</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, #0f0c29 0%, #1a1a3e 50%, #24243e 100%);
      min-height: 100vh;
      color: #fff;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      text-align: center;
      padding: 30px 0 40px;
    }

    .header h1 {
      font-size: 2.2rem;
      font-weight: 700;
      background: linear-gradient(90deg, #f97316, #fb923c, #fbbf24);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: inline-flex;
      align-items: center;
      gap: 12px;
    }

    .header h1::before {
      content: "ğŸ“¦";
      -webkit-text-fill-color: initial;
    }

    .header p {
      color: #a0a0b0;
      margin-top: 10px;
      font-size: 0.95rem;
    }

    /* Main Grid */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1.2fr 1fr;
      gap: 24px;
    }

    @media (max-width: 1200px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Card */
    .card {
      background: rgba(30, 30, 50, 0.8);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .step-number {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    /* Tab Switcher */
    .tab-switcher {
      display: flex;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 4px;
      margin-bottom: 16px;
    }

    .tab-btn {
      flex: 1;
      padding: 10px 16px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: #a0a0b0;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: #fff;
    }

    .tab-btn:hover:not(.active) {
      color: #fff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Upload Area */
    .upload-area {
      border: 2px dashed rgba(34, 211, 238, 0.5);
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(34, 211, 238, 0.05);
    }

    .upload-area:hover {
      border-color: #22d3ee;
      background: rgba(34, 211, 238, 0.1);
    }

    .upload-area.dragover {
      border-color: #22d3ee;
      background: rgba(34, 211, 238, 0.15);
      transform: scale(1.02);
    }

    .upload-area.uploaded {
      border-color: #22c55e;
      background: rgba(34, 197, 94, 0.1);
    }

    .upload-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    .upload-text {
      color: #e0e0e0;
      font-size: 0.95rem;
    }

    .upload-subtext {
      color: #808090;
      font-size: 0.8rem;
      margin-top: 6px;
    }

    .file-info {
      margin-top: 16px;
      padding: 12px;
      background: rgba(34, 197, 94, 0.1);
      border-radius: 8px;
      color: #22c55e;
      font-size: 0.9rem;
    }

    .reset-btn {
      margin-top: 16px;
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: inherit;
    }

    .reset-btn:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    /* URL Input Area */
    .url-input-area {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .url-input {
      padding: 14px 16px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      color: #fff;
      font-size: 0.9rem;
      font-family: inherit;
      transition: all 0.2s;
    }

    .url-input:focus {
      outline: none;
      border-color: #22d3ee;
      box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.2);
    }

    .url-input::placeholder {
      color: #606070;
    }

    .fetch-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, #22d3ee, #06b6d4);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .fetch-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(34, 211, 238, 0.4);
    }

    .fetch-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .url-hint {
      font-size: 0.75rem;
      color: #808090;
      line-height: 1.5;
    }

    .url-hint a {
      color: #22d3ee;
      text-decoration: none;
    }

    .url-hint a:hover {
      text-decoration: underline;
    }

    /* Form Inputs */
    .form-section {
      margin-bottom: 20px;
    }

    .form-section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-section-title.orange {
      color: #fb923c;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-label {
      font-size: 0.8rem;
      color: #a0a0b0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .form-input {
      padding: 12px 14px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      color: #fff;
      font-size: 0.95rem;
      font-family: inherit;
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #22d3ee;
      box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.2);
    }

    .form-input::placeholder {
      color: #606070;
    }

    .form-input-row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
    }

    .form-input-row-4 {
      display: grid;
      grid-template-columns: 1fr 1fr 80px 60px;
      gap: 10px;
    }

    select.form-input {
      cursor: pointer;
    }

    /* Checkbox */
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 8px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .checkbox-label input {
      width: 18px;
      height: 18px;
      accent-color: #22c55e;
      cursor: pointer;
    }

    /* Options Section */
    .options-section {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 16px;
      margin-top: 16px;
    }

    .options-title {
      font-size: 0.85rem;
      color: #a0a0b0;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Generate Button */
    .generate-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: inherit;
    }

    .generate-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
    }

    .generate-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Output Area */
    .output-area {
      min-height: 300px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 20px;
      position: relative;
    }

    .output-placeholder {
      color: #606070;
      text-align: center;
      padding-top: 100px;
      font-size: 0.95rem;
    }

    .output-text {
      white-space: pre-wrap;
      line-height: 1.8;
      font-size: 0.95rem;
      color: #e0e0e0;
    }

    .copy-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 8px 16px;
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid rgba(34, 197, 94, 0.4);
      border-radius: 6px;
      color: #22c55e;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      display: none;
      font-family: inherit;
    }

    .copy-btn:hover {
      background: rgba(34, 197, 94, 0.3);
    }

    .copy-btn.visible {
      display: block;
    }

    .copy-btn.copied {
      background: #22c55e;
      color: #fff;
    }

    /* Hidden file input */
    #fileInput {
      display: none;
    }

    /* Loading */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #22c55e;
      color: #fff;
      padding: 14px 28px;
      border-radius: 10px;
      font-weight: 500;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.error {
      background: #ef4444;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Hå±æ€§ è¿”é€æ–‡è¨€ä½œæˆãƒ„ãƒ¼ãƒ«</h1>
      <p>Excelãƒ•ã‚¡ã‚¤ãƒ« ã¾ãŸã¯ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURL â†’ ç™ºé€æƒ…å ±ã‚’å…¥åŠ› â†’ æ–‡è¨€ã‚’è‡ªå‹•ç”Ÿæˆ</p>
    </header>

    <div class="main-grid">
      <!-- Column 1: Upload -->
      <div class="card">
        <div class="card-header">
          <div class="step-number">1</div>
          <h2 class="card-title">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</h2>
        </div>
        
        <!-- Tab Switcher -->
        <div class="tab-switcher">
          <button class="tab-btn active" onclick="switchTab('excel')">ğŸ“ Excelãƒ•ã‚¡ã‚¤ãƒ«</button>
          <button class="tab-btn" onclick="switchTab('url')">ğŸ”— ã‚¹ãƒ—ã‚·URL</button>
        </div>

        <!-- Excel Tab -->
        <div class="tab-content active" id="tab-excel">
          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">ã“ã“ã«Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div>
            <div class="upload-subtext">ã¾ãŸã¯ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
          </div>
          
          <div class="file-info" id="fileInfo" style="display: none;"></div>
          
          <button class="reset-btn" id="resetBtn" style="display: none;" onclick="resetUpload()">
            ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
          </button>
        </div>

        <!-- URL Tab -->
        <div class="tab-content" id="tab-url">
          <div class="url-input-area">
            <input type="text" class="url-input" id="spreadsheetUrl" placeholder="ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‚’è²¼ã‚Šä»˜ã‘">
            <button class="fetch-btn" id="fetchBtn" onclick="fetchSpreadsheet()">
              ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            </button>
            <div class="url-hint">
              â€» ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®šã‚’<br>
              ã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ãŒé–²è¦§å¯ã€ã«ã—ã¦ãã ã•ã„<br>
              â€» ã‚·ãƒ¼ãƒˆ2ã®ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ã§å–å¾—ã—ã¾ã™
            </div>
          </div>
          
          <div class="file-info" id="urlInfo" style="display: none;"></div>
          
          <button class="reset-btn" id="resetUrlBtn" style="display: none;" onclick="resetUrl()">
            ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
          </button>
        </div>
        
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
      </div>

      <!-- Column 2: Input Form -->
      <div class="card">
        <div class="card-header">
          <div class="step-number">2</div>
          <h2 class="card-title">ç™ºé€æƒ…å ±ã‚’å…¥åŠ›</h2>
        </div>

        <div class="form-section">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ğŸ“… æ—¥ä»˜</label>
              <input type="text" class="form-input" id="inputDate" placeholder="ä¾‹: 1/5">
            </div>
            <div class="form-group">
              <label class="form-label">ğŸ“ è¿”é€å…ˆ</label>
              <input type="text" class="form-input" id="inputStore" placeholder="ä¾‹: åè°·åº—">
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-section-title orange">ğŸ“¦ ç™ºé€æƒ…å ±</div>
          <div class="form-group" style="margin-bottom: 12px;">
            <label class="form-label">è¿½è·¡ç•ªå·</label>
            <input type="text" class="form-input" id="inputTracking" placeholder="ä¾‹: 454324255221">
          </div>
          <div class="form-input-row-4">
            <input type="text" class="form-input" id="inputArrivalDate" placeholder="ç€æ—¥ï¼ˆä¾‹: 1/10ï¼‰">
            <select class="form-input" id="inputArrivalTime">
              <option value="AM">åˆå‰</option>
              <option value="PM" selected>åˆå¾Œ</option>
            </select>
            <input type="number" class="form-input" id="inputPackageCount" value="1" min="1" style="text-align: center;">
            <span style="display: flex; align-items: center; color: #a0a0b0; font-size: 0.9rem;">å€‹å£</span>
          </div>
        </div>

        <div class="options-section">
          <div class="options-title">âš™ï¸ ã‚ªãƒ—ã‚·ãƒ§ãƒ³</div>
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" id="optionReason" checked>
              è¿”å“ç†ç”±ã‚’å«ã‚ã‚‹
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="optionList" checked>
              ãƒªã‚¹ãƒˆè¿”é€ã‚ã‚Š
            </label>
          </div>
        </div>
      </div>

      <!-- Column 3: Output -->
      <div class="card">
        <div class="card-header">
          <div class="step-number">3</div>
          <h2 class="card-title">æ–‡è¨€ã‚’ç”Ÿæˆ</h2>
        </div>

        <button class="generate-btn" id="generateBtn" onclick="generateMessage()">
          âœ¨ è¿”é€æ–‡è¨€ã‚’ç”Ÿæˆ
        </button>

        <div class="output-area" id="outputArea" style="margin-top: 16px;">
          <button class="copy-btn" id="copyBtn" onclick="copyToClipboard()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
          <div class="output-placeholder" id="outputPlaceholder">
            ã¾ãšãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„
          </div>
          <div class="output-text" id="outputText" style="display: none;"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</div>

  <script>
    // GAS API URL
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbzJ75BJbk-9Ks6lDWx-8PEYM3T2VBJZjg76LB3rnY7fzGuDStSuhG_65nnbZseUfg4IMQ/exec';

    // Global state
    let uploadedData = null;
    let currentTab = 'excel';

    // DOM Elements
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const resetBtn = document.getElementById('resetBtn');
    const urlInfo = document.getElementById('urlInfo');
    const resetUrlBtn = document.getElementById('resetUrlBtn');
    const generateBtn = document.getElementById('generateBtn');
    const outputPlaceholder = document.getElementById('outputPlaceholder');
    const outputText = document.getElementById('outputText');
    const copyBtn = document.getElementById('copyBtn');
    const toast = document.getElementById('toast');

    // Tab Switching
    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      if (tab === 'excel') {
        document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
        document.getElementById('tab-excel').classList.add('active');
      } else {
        document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
        document.getElementById('tab-url').classList.add('active');
      }
    }

    // Upload Area Events
    uploadArea.addEventListener('click', () => fileInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });

    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
      }
    });

    // Handle File Upload
    function handleFile(file) {
      const validTypes = [
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.ms-excel',
        'text/csv'
      ];
      
      if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls|csv)$/i)) {
        showToast('Excel ã¾ãŸã¯ CSV ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', true);
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          
          // Try to get "ã‚·ãƒ¼ãƒˆ2" first, then fall back to second sheet or first sheet
          let sheetName = workbook.SheetNames.find(name => name === 'ã‚·ãƒ¼ãƒˆ2');
          if (!sheetName && workbook.SheetNames.length > 1) {
            sheetName = workbook.SheetNames[1];
          }
          if (!sheetName) {
            sheetName = workbook.SheetNames[0];
          }
          
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          // Filter out empty rows and header
          uploadedData = jsonData.filter((row, index) => {
            if (index === 0) return false; // Skip header
            return row.some(cell => cell !== undefined && cell !== '');
          });

          // Update UI
          uploadArea.classList.add('uploaded');
          uploadArea.innerHTML = `
            <div class="upload-icon">âœ…</div>
            <div class="upload-text">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†</div>
          `;
          
          fileInfo.style.display = 'block';
          fileInfo.innerHTML = `ğŸ“„ ${file.name}<br>å•†å“æ•°: ${uploadedData.length}ä»¶`;
          
          resetBtn.style.display = 'inline-flex';
          outputPlaceholder.textContent = 'ç™ºé€æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã€Œè¿”é€æ–‡è¨€ã‚’ç”Ÿæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯';
          
        } catch (error) {
          console.error(error);
          showToast('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // Fetch Spreadsheet from URL via GAS API
    async function fetchSpreadsheet() {
      const url = document.getElementById('spreadsheetUrl').value.trim();
      
      if (!url) {
        showToast('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
        return;
      }

      // Extract spreadsheet ID from URL
      const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
      if (!match) {
        showToast('ç„¡åŠ¹ãªã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã§ã™', true);
        return;
      }

      const spreadsheetId = match[1];
      const fetchBtn = document.getElementById('fetchBtn');
      
      // Show loading
      fetchBtn.disabled = true;
      fetchBtn.innerHTML = '<span class="loading"></span> å–å¾—ä¸­...';

      try {
        // Fetch via GAS API
        const apiUrl = `${GAS_API_URL}?id=${spreadsheetId}`;
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
          throw new Error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const result = await response.json();
        
        if (result.error) {
          throw new Error(result.error);
        }

        if (!result.data || result.data.length === 0) {
          throw new Error('ã‚·ãƒ¼ãƒˆ2ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        }

        // Store data
        uploadedData = result.data;

        // Update UI
        urlInfo.style.display = 'block';
        urlInfo.innerHTML = `âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†<br>å•†å“æ•°: ${result.count}ä»¶`;
        
        resetUrlBtn.style.display = 'inline-flex';
        outputPlaceholder.textContent = 'ç™ºé€æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã€Œè¿”é€æ–‡è¨€ã‚’ç”Ÿæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯';
        
        showToast('ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸï¼');

      } catch (error) {
        console.error(error);
        showToast(error.message || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
      } finally {
        fetchBtn.disabled = false;
        fetchBtn.innerHTML = 'ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—';
      }
    }

    // Reset Upload
    function resetUpload() {
      uploadedData = null;
      fileInput.value = '';
      uploadArea.classList.remove('uploaded');
      uploadArea.innerHTML = `
        <div class="upload-icon">ğŸ“</div>
        <div class="upload-text">ã“ã“ã«Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div>
        <div class="upload-subtext">ã¾ãŸã¯ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
      `;
      fileInfo.style.display = 'none';
      resetBtn.style.display = 'none';
      resetOutput();
    }

    // Reset URL
    function resetUrl() {
      uploadedData = null;
      document.getElementById('spreadsheetUrl').value = '';
      urlInfo.style.display = 'none';
      resetUrlBtn.style.display = 'none';
      resetOutput();
    }

    // Reset Output
    function resetOutput() {
      outputPlaceholder.textContent = 'ã¾ãšãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„';
      outputPlaceholder.style.display = 'block';
      outputText.style.display = 'none';
      copyBtn.classList.remove('visible');
    }

    // Generate Message
    function generateMessage() {
      if (!uploadedData || uploadedData.length === 0) {
        showToast('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', true);
        return;
      }

      const date = document.getElementById('inputDate').value.trim();
      const store = document.getElementById('inputStore').value.trim();
      const tracking = document.getElementById('inputTracking').value.trim();
      const arrivalDate = document.getElementById('inputArrivalDate').value.trim();
      const arrivalTime = document.getElementById('inputArrivalTime').value;
      const packageCount = document.getElementById('inputPackageCount').value;
      const includeReason = document.getElementById('optionReason').checked;
      const includeListNote = document.getElementById('optionList').checked;

      // Validation
      if (!date || !store || !tracking || !arrivalDate) {
        showToast('ç™ºé€æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
        return;
      }

      // Process data
      const allProducts = [];
      const redProducts = [];    // æœªå‡ºå“ï¼ˆFåˆ—ã«è¿”å“ç†ç”±ã‚ã‚Šï¼‰
      const orangeProducts = []; // è²©å£²æ¸ˆï¼ˆEåˆ—ã«ã€Œè²©å£²ã€å«ã‚€ï¼‰

      uploadedData.forEach(row => {
        if (!row[0] && !row[1] && !row[2]) return; // Skip empty rows

        const product = {
          no: row[0] || '',
          brand: row[1] || '',
          name: row[2] || '',
          price: row[3] || '',
          note: row[4] || '',
          reason: row[5] || ''
        };

        allProducts.push(product);

        // Fåˆ—ï¼ˆè¿”å“ç†ç”±ï¼‰ã«è¨˜è¼‰ã‚ã‚Š â†’ æœªå‡ºå“
        if (product.reason && String(product.reason).trim() !== '') {
          redProducts.push(product);
        }
        // Eåˆ—ï¼ˆå‚™è€ƒï¼‰ã«ã€Œè²©å£²ã€å«ã‚€ â†’ è²©å£²æ¸ˆ
        else if (product.note && String(product.note).includes('è²©å£²')) {
          orangeProducts.push(product);
        }
      });

      // Build message
      let message = '';
      
      // Header
      message += `${date} ${store}æ§˜ï¼ˆ${allProducts.length}ç‚¹åœ¨ä¸­ï¼‰\n`;
      message += `ã®å‡ºå“ä½œæ¥­ãŒå®Œäº†ã„ãŸã—ã¾ã—ãŸã€‚\n`;

      // æœªå‡ºå“ï¼ˆèµ¤ï¼‰
      if (redProducts.length > 0) {
        message += `\nä¸‹è¨˜${redProducts.length}ç‚¹æœªå‡ºå“ã¨ãªã‚Šã¾ã™ã€‚\n`;
        redProducts.forEach(p => {
          message += `${p.no} ${p.brand}ã€€${p.name}`;
          if (includeReason && p.reason) {
            message += `ï¼ˆ${p.reason}ï¼‰`;
          }
          message += '\n';
        });
        if (includeListNote) {
          message += `ãƒªã‚¹ãƒˆèµ¤è‰²ã§è‰²ä»˜ã‘ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚\n`;
        }
      }

      // è²©å£²æ¸ˆï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰
      if (orangeProducts.length > 0) {
        message += `\nä¸‹è¨˜${orangeProducts.length}ç‚¹è¿”é€å‰ã«è²©å£²ã¨ãªã‚Šã¾ã—ãŸã€‚\n`;
        orangeProducts.forEach(p => {
          message += `${p.no} ${p.brand}ã€€${p.name}\n`;
        });
        if (includeListNote) {
          message += `ãƒªã‚¹ãƒˆã‚ªãƒ¬ãƒ³ã‚¸è‰²ã§è‰²ä»˜ã‘ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚\n`;
        }
      }

      // Shipping info
      message += `\næœ¬æ—¥ä½å·æ€¥ä¾¿ã«ã¦ç™ºé€è‡´ã—ã¾ã™ã€‚\n`;
      message += `ãŠå•ã„åˆã‚ã›NO ${tracking} ${arrivalDate} ${arrivalTime}ç€ ${packageCount}å€‹å£\n`;
      message += `${store}æ§˜ã¸ç™ºé€ã„ãŸã—ã¾ã™ã€‚\n`;
      message += `å®œã—ããŠé¡˜ã„è‡´ã—ã¾ã™ã€‚`;

      // Display output
      outputPlaceholder.style.display = 'none';
      outputText.style.display = 'block';
      outputText.textContent = message;
      copyBtn.classList.add('visible');
    }

    // Copy to Clipboard
    function copyToClipboard() {
      const text = outputText.textContent;
      navigator.clipboard.writeText(text).then(() => {
        copyBtn.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼å®Œäº†';
        copyBtn.classList.add('copied');
        showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼LINEã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
        
        setTimeout(() => {
          copyBtn.textContent = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼';
          copyBtn.classList.remove('copied');
        }, 2000);
      }).catch(() => {
        // Fallback
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
      });
    }

    // Show Toast
    function showToast(message, isError = false) {
      toast.textContent = message;
      toast.classList.toggle('error', isError);
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
  </script>
</body>
</html>
